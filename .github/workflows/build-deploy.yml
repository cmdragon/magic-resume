name: Build and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# è®¾ç½®æƒé™
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # æ·»åŠ ç¯å¢ƒå˜é‡
    env:
      NODE_ENV: production
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ä»¥æ”¯æŒåˆ†æ”¯æ“ä½œ
      
      # è®¾ç½®Node.jsç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      # è®¾ç½®pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.3.0
          run_install: false
      
      # è·å–pnpm storeç›®å½•
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      # ç¼“å­˜pnpmä¾èµ–
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          echo "æ­£åœ¨å®‰è£…pnpmä¾èµ–..."
          pnpm install --frozen-lockfile
          echo "ä¾èµ–å®‰è£…å®Œæˆ"
          pnpm list --depth=0
        
      # æ„å»ºNext.jsé¡¹ç›®
      - name: Build Next.js Application
        run: |
          echo "æ­£åœ¨æ„å»ºNext.jsåº”ç”¨..."
          pnpm run build
          echo "Next.jsåº”ç”¨æ„å»ºå®Œæˆ"
          ls -la .next/
          # æ£€æŸ¥æ„å»ºè¾“å‡º
          echo "æ„å»ºäº§ç‰©ç»Ÿè®¡:"
          du -sh .next/
      
      # è·å–å½“å‰æ—¥æœŸ
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
      # æ‰“åŒ…æ„å»ºäº§ç‰©
      - name: Package Build Artifacts
        run: |
          echo "æ‰“åŒ…æ„å»ºäº§ç‰©..."
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release
          # æ£€æŸ¥æ˜¯å¦æœ‰standaloneè¾“å‡º
          if [ -d ".next/standalone" ]; then
            echo "âœ… å‘ç°standaloneè¾“å‡ºï¼Œæ‰“åŒ…è‡ªåŒ…å«åº”ç”¨"
            tar -czf release/magic-resume-build.tar.gz .next/standalone/ .next/static/ public/ package.json pnpm-lock.yaml
            echo "ğŸ“¦ è‡ªåŒ…å«æ¨¡å¼ï¼šæ— éœ€å®‰è£…ä¾èµ–ï¼Œç›´æ¥è¿è¡Œ node server.js"
          else
            echo "âš ï¸ æœªå‘ç°standaloneè¾“å‡ºï¼Œæ‰“åŒ…å®Œæ•´æ„å»ºç›®å½•"
            tar -czf release/magic-resume-build.tar.gz .next/ public/ package.json pnpm-lock.yaml
            echo "ğŸ“¦ æ ‡å‡†æ¨¡å¼ï¼šéœ€è¦å…ˆ pnpm install --prod (æ³¨æ„ä½¿ç”¨pnpmè€Œénpm)"
          fi
          
          # åˆ›å»ºéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶
          echo "æ„å»ºæ—¶é—´: $(date)" > release/build-info.txt
          echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> release/build-info.txt
          echo "åˆ†æ”¯: ${{ github.ref_name }}" >> release/build-info.txt
          echo "åº”ç”¨ç±»å‹: SSR Next.js Application" >> release/build-info.txt
          echo "ç‰¹æ®Šä¾èµ–: puppeteer, chromium, sharp (éœ€è¦è¿è¡Œæ—¶å®‰è£…)" >> release/build-info.txt
          echo "åŒ…ç®¡ç†å™¨: pnpm (è¯·ä½¿ç”¨ pnpm è€Œé npm)" >> release/build-info.txt
          
          # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ:"
          ls -lh release/
          echo "ğŸ“Š æ–‡ä»¶å¤§å°:"
          du -h release/*
      
      # å‘å¸ƒåˆ° GitHub Releases
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: build-${{ github.run_number }}-${{ github.sha }}
          name: æ„å»ºç‰ˆæœ¬ ${{ github.run_number }}
          body: |
            ğŸš€ **è‡ªåŠ¨æ„å»ºå‘å¸ƒ**
            
            - **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
            - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}
            
            ## ğŸ“¦ åŒ…å«æ–‡ä»¶
            - `magic-resume-build.tar.gz` - æ„å»ºäº§ç‰©å‹ç¼©åŒ…
            - `build-info.txt` - æ„å»ºä¿¡æ¯æ–‡ä»¶
            
            ## ğŸš€ éƒ¨ç½²è¯´æ˜
            
            ### éƒ¨ç½²æ–¹å¼è‡ªåŠ¨æ£€æµ‹ï¼š
            - **å¦‚æœåŒ…å« `standalone`**: ç›´æ¥è¿è¡Œ `node server.js`ï¼Œæ— éœ€å®‰è£…ä¾èµ–
            - **å¦‚æœä¸åŒ…å«**: éœ€è¦å…ˆ `pnpm install --prod` å† `pnpm start`
            
            âš ï¸ **é‡è¦æé†’**: è¯·ä½¿ç”¨ `pnpm` è€Œé `npm`ï¼Œé¡¹ç›®ä½¿ç”¨ pnpm-lock.yaml
            
            > âš ï¸ **æ³¨æ„**: æœ¬åº”ç”¨ä½¿ç”¨ puppeteer/chromium è¿›è¡Œ PDF ç”Ÿæˆï¼Œé€šå¸¸éœ€è¦å®‰è£…ä¾èµ–æ‰èƒ½æ­£å¸¸å·¥ä½œ
            
          files: |
            release/magic-resume-build.tar.gz
            release/build-info.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


